<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Entities explained</title>

  <link rel="stylesheet" href="dist/reset.css">
  <link rel="stylesheet" href="dist/reveal.css">
  <link rel="stylesheet" href="dist/theme/solarized.css">

  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="plugin/highlight/monokai.css">
  <style>
    .smaller {
      font-size: 30px;
    }
    .hljs-comment {
      color: lightskyblue;
    }
  </style>
</head>
<body>
<div class="reveal">
  <div class="slides">
    <section><h1 class="r-fit-text">Entities <em>Explained</em></h1></section>
    <section><h2>About me</h2></section>
    <section><h2>Topics</h2>
      <ul>
        <li>Terminology, concepts</li>
        <li>Content entities, fields and typed data</li>
        <li>Revisions, Content moderation</li>
        <li>Content translation</li>
        <li>Storage</li>
        <li>Displaying entities</li>
        <li>Access</li>
        <li>New in Drupal 9.3: Bundle classes</li>
      </ul>
    </section>
    <section>
      <section><h2 class="r-fit-text">Terminology</h2></section>
      <section>
        <h3>Entity type</h3>
        <p>
          A certain type of entities. Also typically used as a variable name for the entity type
          definition, consisting of the ID, labels, handlers and other information
          that makes up an entity type.
        </p>
        <h4>Examples</h4>
        <p>
          Node/Content (node), Term (taxonomy_term), User (user), User Role (user_role)<br>
        </p>
        <pre><code class="language-php">\Drupal\Core\Entity\EntityTypeInterface</code></pre>
      </section>
      <section>
        <h3>Entity</h3>
        <p>
          A generic concept to store and access data.
          A specific entity, identified by entity type and ID.
        </p>
        <h4>Examples</h4>
        <p>
          Node 1, User 17.
        </p>
        <pre><code class="language-php">\Drupal\Core\Entity\EntityInterface
\Drupal\node\Entity\Node (\Drupal\node\NodeInterface)</code></pre>
      </section>
      <section>
        <h3>Content entity (types)</h3>
        <p>
          A group of entity types that use fields and typed data. Many more
          features like revisions, translations. Complex but predictable data
          structures.
        </p>
        <h4>Examples</h4>
        <p>
          Node, User, File, Term.
        </p>
        <pre><code class="language-php">\Drupal\Core\Entity\ContentEntityInterface</code></pre>
      </section>
      <section>
        <h3>Config entity (types)</h3>
        <p>
          A group of entity types that use the config system as storage.
          Machine names as ID, inherits featurs of config (export, deploy,
          config translations). Plain data. Often uses one or multiple plugins.
        </p>
        <h4>Examples</h4>
        <p>
          User Role, Vocabulary, Node Type, Block, View
        </p>
        <pre><code class="language-php">\Drupal\Core\Config\Entity\ConfigEntityInterface</code></pre>
      </section>
      <section>
        <h3>Handlers</h3>
        <p>
          An extensible system to add functionality to entity types that can be
          customized per entity type.
        </p>
        <h4>Examples</h4>
        <p>
          Storage, Access Control Handler, Forms, View Builder, Views Data
        </p>
      </section>
      <section>
        <h3>Bundles</h3>
        <p>
          Variants/subtypes of content entities that can have different fields, form/view displays, templates.
        </p>
        <p>
          Bundles are often managed as config entities themselves but do not have to be, can be other plugins or
          hardcoded.
        </p>
        <h4>Examples</h4>
        <p>
          Node: Node type, Term: Vocabulary, Media: Media type.
        </p>
        <pre><code class="language-php">$entity->bundle(), hook_entity_bundle_info()</code></pre>
      </section>
      <section>
        <h3>Form/View modes and displays</h3>
        <p>
          Configuration how content entities are viewed/edited. Displays contain components (mostly widget/formatter configuration for fields) for a given bundle.
          Modes define which displays may exist for a given entity type.
        </p>
        <h4>Examples</h4>
        <p>
          View mode: Teaser, View display: Teaser for Node articles, Form mode/display: Edit profile/register for users.
        </p>
      </section>
      <section>
        <h3>Typed data</h3>
        <p>
          A generic API to describe data and data structures. Entities and related objects are either typed data or
          a typed data representation of it can be accessed.
        </p>
        <p>
          A list contains N items with the same definition, complex data (map)
          contains a fixed amount of items identified by a key.
        </p>
        <pre><code class="language-php">\Drupal\Core\TypedData\TypedDataInterface
\Drupal\Core\TypedData\PrimitiveValues
\Drupal\Core\TypedData\ListInterface
\Drupal\Core\TypedData\ComplexDataInterface</code></pre>
      </section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Content entities, fields, typed data</h2></section>
      <section>
        <h3>Structure</h3>
        <ul>
          <li>A content entity is a container of fields.</li>
          <li>A field is a list of field items</li>
          <li>A field item is a container of properties</li>
          <li>Properties are typed data: primitive values (integer, string, ..), objects (language, date, ..) or references to another entity</li>
        </ul>
      </section>
      <section>
        <h3>Interfaces</h3>
        <table class="smaller">
          <thead>
          <tr>
            <th>Name</th>
            <th>Interface</th>
            <th>Typed Data</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Entity</td>
            <td>ContentEntityInterface</td>
            <td>::getTypedData()<br />EntityAdapter (complex data)</td>
          </tr>
          <tr>
            <td>Field</td>
            <td>FieldItemListInterface</td>
            <td>ListInterface</td>
          </tr>
          <tr>
            <td>Field&nbsp;item</td>
            <td>FieldItemInterface</td>
            <td>ComplexDataInterface</td>
          </tr>
          <tr>
            <td>Property</td>
            <td colspan="2">PrimitiveInterface (non-computed, stored properites) or TypedDataInterface</td>
          </tr>
          </tbody>
        </table>
      </section>
      <section>
        <h3>Field definition</h3>
        <ul>
          <li>
            <code>FieldStorageDefinitionInterface</code><br />
            Shared between bundles, information and settings that are used for
            the storage (table definition): Type, machine name, storage settings, type, entity type, cardinality, ...
          </li>
          <li>
            <code>FieldDefinitionInterface</code><br />
            Remaining configuration that can vary between bundles for the same field machine name: Label, bundle, settings, required, ...
          </li>
        </ul>
      </section>
      <section>
        <h3>Field definition</h3>
        <ul>
          <li>
            <code>BaseFieldDefinition implements FieldStorageDefinitionInterface, FieldDefinitionInterface</code><br />
            Base fields are defined in code, in <code>::baseFieldDefinitions</code> of the entity class and  shared across all bundles.
          </li>
        </ul>
      </section>
      <section>
        <h3>Field definition</h3>
        <ul>
          <li>
            <code>FieldStorageConfig implements FieldStorageDefinitionInterface</code><br />
            Storage settings for configurable fields (first step of creating a field in the UI)
          </li>
          <li>
            <code>FieldConfig implements FieldDefinitionInterface</code><br />
            Field definition for configurable fields (second step of creating a field in the UI)
          </li>
        </ul>
      </section>
      <section>
        <h3>Field definition</h3>
        <h4>Accessing field definitions with an entity</h4>
        <pre><code class="language-php" data-line-numbers="1|2|3|4" data-trim>
$entity->getFieldDefinitions();
$entity->getFieldDefinition('field_name')
$entity->get('field_name')->getFieldDefinition()
$field_definition->getFieldStorageDefinition()
        </code></pre>
      </section>
      <section>
        <h3>Field definition</h3>
        <h4>Accessing field definitions without an entity</h4>
        <pre><code class="language-php" data-line-numbers="1|2|3|4" data-trim>
$entity_field_manager = \Drupal::service('entity_field.manager')
$entity_field_manager->getFieldStorageDefinitions($entity_type_id)
$entity_field_manager->getFieldDefinitions($entity_type_id, $bundle)
        </code></pre>
      </section>
      <section>
        <h3>Field types</h3>
        <ul>
          <li>Field types are defines as plugins with annotations</li>
          <li>Represent the field item class</li>
          <li>Define their children (properties)</li>
          <li>Optionally provide a field item list class as well</li>
        </ul>
      </section>
      <section>
        <h3>Field type example</h3>
        <pre><code class="language-php" data-line-numbers="1-11|13-19|21-29|31-41" data-trim>
/**
 * @FieldType(
 *   id = "string",
 *   label = @Translation("Text (plain)"),
 *   description = @Translation("A field containing a plain string value."),
 *   category = @Translation("Text"),
 *   default_widget = "string_textfield",
 *   default_formatter = "string"
 * )
 */
class StringItem extends FieldItemBase {

  public static function defaultStorageSettings() {
    return [
      'max_length' => 255,
      'is_ascii' => FALSE,
      'case_sensitive' => FALSE,
    ] + parent::defaultStorageSettings();
  }

  public static function propertyDefinitions(FieldStorageDefinitionInterface $field_definition) {
    $properties['value'] = DataDefinition::create('string')
      ->setLabel(new TranslatableMarkup('Text value'))
      ->setSetting('case_sensitive',
          $field_definition->getSetting('case_sensitive'))
      ->setRequired(TRUE);

    return $properties;
  }

  public static function schema(FieldStorageDefinitionInterface $field_definition) {
    return [
      'columns' => [
        'value' => [
          'type' => $field_definition->getSetting('is_ascii') === TRUE ? 'varchar_ascii' : 'varchar',
          'length' => (int) $field_definition->getSetting('max_length'),
          'binary' => $field_definition->getSetting('case_sensitive'),
        ],
      ],
    ];
  }

  // ...
}
        </code></pre>
      </section>
      <section>
        <h3>Accessing and setting values</h3>
        <h4>Accessing a field property</h4>
        <pre><code class="language-php" data-line-numbers="1-2|3-4|5-6|7-8" data-trim>
// Complete
$entity->get('field')->get(0)->get('property')->getValue();
// Array access
$entity->get('field')[0]->get('property')->getValue();
// __get() for properties equals ->get('property)->getValue();
$entity->get('field')[0]->property;
// Delta 0 is the default for properties when working with __get()
$entity->get('field')->property;
</code></pre>
      </section>
      <section>
        <h3>Accessing and setting values</h3>
        <h4><code>getValue()</code></h4>
        <pre><code class="language-php" data-line-numbers="1-3|4-6|7-12|13-15" data-trim>
// On a field item.
 $user->get('roles')[0]->get('target_id')->getValue()
=> "content_editor"
// On a field item.
$user->get('roles')[0]->getValue();
=> ["target_id" => "content_editor"]
// On a field.
$user->get('roles')->getValue();
=> [
    0 => ["target_id" => "content_editor"],
    1 => ["target_id" => "administrator"],
   ]
// Shorthand, get a single property of all items.
array_column($user->get('roles')->getValue(), 'target_id')
=> ["content_editor", "administrator"]
</code></pre>
      </section>
      <section>
        <h3>Accessing and setting values</h3>
        <h4>Setting values</h4>
        <pre><code class="language-php" data-line-numbers="1-2|3-4|5-6|7-8|9-10|11-12" data-trim>
// Complete
$entity->get('field')->get(0)->get('property')->setValue('myvalue');
// Magic
$entity->get('field')->property = 'myvalue';
// ContentEntityInterface::set(), single/main property.
$entity->set('field', 'myvalue');
// ContentEntityInterface::set(), multiple properties.
$node->set('body', ['value' => 'Hello', 'format' => 'plain_text']);
// ContentEntityInterface::set(), multiple items.
$user->set('roles', ['content_editor', 'administrator']);
// Append an item.
$user->get('roles')->appendItem('administrator');
</code></pre>
      </section>
    </section>
      <section>
        <h3>Do's, Don'ts and  gotchas</h3>
        <h4>Property names vs. generic methods</h4>
        <pre><code class="language-php" data-line-numbers="1-5|6-9" data-trim>
$node->get('title')->value
// is shorthand for
$node->get('title')->get('value')->getValue()
// And not the same as
$node->get('title')->getValue()
// ->entity on entity reference fields is the target.
$user->get('roles')->entity == $role;
// ->getEntity() is the host/parent entity.
$user->get('roles')->getEntity() == $user;
</code></pre>
      </section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Revisions, Content moderation</h2></section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Content translation</h2></section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Entity Storage</h2></section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Displaying entities</h2></section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Bundle classes</h2></section>
    </section>
  </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>
  // More info about initialization & config:
  // - https://revealjs.com/initialization/
  // - https://revealjs.com/config/
  Reveal.initialize({
    hash: true,
    slideNumber: 'c/t',

    // Learn about plugins: https://revealjs.com/plugins/
    plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
  });
</script>
</body>
</html>
